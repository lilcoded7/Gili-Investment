{% extends 'dash/base.html' %}

{% load static %}

{% block content %}

<main class="main-content" id="mainContent">
  <header class="top-header">
    <div style="display:flex;align-items:center;gap:12px">
      <button id="mobileMenuBtn" class="mobile-menu-btn" style="display:none;padding:8px;border-radius:8px;background:var(--primary-blue);color:var(--primary-gold);border:none"><i class="fas fa-bars"></i></button>
      <div class="search-box"><i class="fas fa-search" style="color:var(--primary-gold);margin-right:10px"></i><input placeholder="Search markets, assets..." /></div>
    </div>
    <div class="user-menu">
      <div class="notification" id="notificationIcon"><i class="fas fa-bell"></i><span id="notifCount" class="notification-badge" style="display:none">0</span></div>
      <div class="user-profile"><div class="user-avatar">{% if customer and customer.customer and customer.customer.full_name %}{{ customer.customer.full_name|slice:":1"|upper }}{% else %}JD{% endif %}</div>
        <div style="display:flex;flex-direction:column;text-align:left">
          <div style="font-weight:700">{{ request.user.username|default:"John Doe" }}</div>
          <div style="color:var(--primary-gold);font-size:.85rem">{% if customer %}Balance: ${{ customer.balance }}{% else %}No Account{% endif %}</div>
        </div>
      </div>
    </div>
  </header>

  <div class="dashboard-content">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon balance-icon"><i class="fas fa-dollar-sign"></i></div>
        <div class="stat-info"><h3>${{ customer.balance|default:"0.00" }}</h3><p>Account Balance</p></div>
      </div>
      <div class="stat-card">
        <div class="stat-icon investment-icon"><i class="fas fa-chart-pie"></i></div>
        <div class="stat-info"><h3>${{ open_trades|length|add:"0" }}</h3><p>Total Investment</p></div>
      </div>
      <div class="stat-card">
        <div class="stat-icon profit-icon"><i class="fas fa-trending-up"></i></div>
        <div class="stat-info"><h3>$2,458.75</h3><p>Total Profit</p></div>
      </div>
      <div class="stat-card">
        <div class="stat-icon trades-icon"><i class="fas fa-exchange-alt"></i></div>
        <div class="stat-info"><h3>{{ open_trades.count }}</h3><p>Active Trades</p></div>
      </div>
    </div>

    <div class="dashboard-grid">
      <div>
        <div class="chart-container">
          <div class="chart-header">
            <div class="chart-title">BTC/USD Chart</div>
            <div class="chart-controls">
              <select id="symbolSelect" class="symbol-select">
                <option value="BINANCE:BTCUSDT">BTC/USD</option>
                <option value="BINANCE:ETHUSDT">ETH/USD</option>
                <option value="BINANCE:XRPUSDT">XRP/USD</option>
                <option value="BINANCE:LTCUSDT">LTC/USD</option>
                <option value="BINANCE:ADAUSDT">ADA/USD</option>
              </select>
              <button class="timeframe-btn active" data-timeframe="60">1H</button>
              <button class="timeframe-btn" data-timeframe="240">4H</button>
              <button class="timeframe-btn" data-timeframe="D">1D</button>
              <button class="timeframe-btn" data-timeframe="W">1W</button>
            </div>
          </div>
          <div id="tradingview_chart" class="tradingview-widget-container"></div>
        </div>

        <div class="positions-container">
          <h3>Your Positions</h3>
          <table class="table">
            <thead>
              <tr>
                <th>Symbol</th><th>Type</th><th>Amount</th><th>Leverage</th><th>Stop Loss</th><th>Take Profit</th><th>Profit/Loss</th><th>Status</th><th>Action</th>
              </tr>
            </thead>
            <tbody id="positionsBody">
              {% for trade in open_trades %}
                <tr data-trade-id="{{ trade.id }}">
                  <td>{{ trade.symbol }}</td>
                  <td>{{ trade.trade_type }}</td>
                  <td>${{ trade.amount }}</td>
                  <td>{{ trade.leverage }}</td>
                  <td>{% if trade.stop_loss %}${{ trade.stop_loss }}{% else %}&ndash;{% endif %}</td>
                  <td>{% if trade.take_profit %}${{ trade.take_profit }}{% else %}&ndash;{% endif %}</td>
                  <td class="profit-loss" data-leverage="{{ trade.leverage }}">$0.00</td>
                  <td><span class="status-badge {% if trade.status == 'open' %}status-open{% else %}status-closed{% endif %}">{{ trade.status|capfirst }}</span></td>
                  <td>
                    {% if trade.status == "open" %}
                    
                       
                    <a href="{% url 'trade:customer_close_trade' trade.id %}"  class="btn-close">Close</a>
                      
                    {% else %}
                      <a href="{% url 'trade:customer_close_trade' trade.id %}"><span class="status-badge">Closed</span></a>
                      
                    {% endif %}
                  </td>
                </tr>
              {% empty %}
                <tr><td colspan="9">No open positions</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <div>
        <div class="trade-form-container">
          <h3>Execute Trade</h3>

          {% if messages %}
            <div class="messages-django">
              {% for message in messages %}
                <div style="color: red;" class="msg-item {% if message.tags %}msg-{{ message.tags }}{% endif %} {% if 'success' in message.tags %}msg-success{% elif 'error' in message.tags %}msg-error{% endif %}">{{ message }}</div>
              {% endfor %}
            </div>
          {% endif %}

          <form id="tradeForm" method="post" action="{% url 'trade:execute_trade' %}">
            {% csrf_token %}
            <div class="trade-type" role="group" aria-label="Trade type">
              {{form.trade_type}}
            </div>

            <div class="form-group">
              <label for="id_symbol">Symbol</label>
              {{ form.symbol }}
              <div class="field-error" data-field="symbol">{% if form.symbol.errors %}{{ form.symbol.errors|join:", " }}{% endif %}</div>
            </div>

            <div class="form-group">
              <label for="id_amount">Investment Amount (USD)</label>
              {{ form.amount }}
              <div class="field-error" data-field="amount">{% if form.amount.errors %}{{ form.amount.errors|join:", " }}{% endif %}</div>
            </div>

            <div class="form-group">
              <label for="id_leverage">Leverage</label>
              {{ form.leverage }}
              <div class="field-error" data-field="leverage">{% if form.leverage.errors %}{{ form.leverage.errors|join:", " }}{% endif %}</div>
            </div>

            <div class="form-group">
              <label for="id_stop_loss">Stop Loss</label>
              {{ form.stop_loss }}
              <div class="field-error" data-field="stop_loss">{% if form.stop_loss.errors %}{{ form.stop_loss.errors|join:", " }}{% endif %}</div>
            </div>

            <div class="form-group">
              <label for="id_take_profit">Take Profit</label>
              {{ form.take_profit }}
              <div class="field-error" data-field="take_profit">{% if form.take_profit.errors %}{{ form.take_profit.errors|join:", " }}{% endif %}</div>
            </div>

            <div style="display:none">
              {{ form.trade_type }}
            </div>

            <button type="submit" class="btn-trade" id="executeTrade">Execute Trade</button>
          </form>
        </div>

        <div style="height:18px"></div>

        <div class="positions-container" style="margin-top:12px">
          <h3>Account</h3>
          <div style="background:var(--white);padding:14px;border-radius:12px;border:1px solid rgba(0,0,0,.04);box-shadow:0 5px 12px rgba(0,0,0,.04)">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
              <div>
                <div style="font-weight:700">Account Number</div>
                <div style="color:var(--text-light)">{{ customer.account_number|default:"â€”" }}</div>
              </div>
              <div style="text-align:right">
                <div style="font-weight:700">Balance</div>
                <div style="color:var(--primary-gold)">${{ customer.balance|default:"0.00" }}</div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

  </div>
</main>

<script>
document.addEventListener("DOMContentLoaded", function() {
  function formatCurrency(value) {
    return (value >= 0 ? "+" : "") + "$" + value.toFixed(2);
  }
  function updateProfitLoss() {
    document.querySelectorAll("#positionsBody tr[data-trade-id]").forEach(row => {
      const profitLossCell = row.querySelector(".profit-loss");
      if (!profitLossCell) return;
      const leverage = parseFloat(profitLossCell.dataset.leverage) || 1;
      let current = parseFloat(profitLossCell.dataset.current || "0");
      let change = (Math.random() * 10 - 5) * leverage;
      let newValue = current + change;
      profitLossCell.dataset.current = newValue;
      profitLossCell.textContent = formatCurrency(newValue);
      profitLossCell.style.color = newValue >= 0 ? "var(--success)" : "var(--danger)";
    });
  }
  setInterval(updateProfitLoss, 1000);
});
</script>

{% endblock content %}
