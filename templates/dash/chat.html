{% extends 'dash/base.html' %}
{% load static %}

{% block content %}
<main class="main-content" id="mainContent">
    <header class="top-header">
        <div style="display:flex;align-items:center;gap:12px">
            <button id="mobileMenuBtn" class="mobile-menu-btn" style="display:none;padding:8px;border-radius:8px;background:var(--primary-blue);color:var(--primary-gold);border:none">
                <i class="fas fa-bars"></i>
            </button>
            <div class="search-box">
                <i class="fas fa-search" style="color:var(--primary-gold);margin-right:10px"></i>
                <input placeholder="Search conversations..." />
            </div>
        </div>
        <div class="user-menu">
            <div class="notification" id="notificationIcon">
                <i class="fas fa-bell"></i>
                <span id="notifCount" class="notification-badge" style="display:none">0</span>
            </div>
            <div class="user-profile">
                <div class="user-avatar">
                    {% if customer and customer.full_name %}
                        {{ customer.full_name|slice:":1"|upper }}
                    {% else %}JD{% endif %}
                </div>
                <div style="display:flex;flex-direction:column;text-align:left">
                    <div style="font-weight:700">{{ request.user.username|default:"John Doe" }}</div>
                    <div style="color:var(--primary-gold);font-size:.85rem">
                        Balance: ${{ customer.balance|default:"0.00" }}
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="dashboard-content">
        <div class="support-container">
            <div class="support-header">
                <h2>Customer Support</h2>
                <p>Get help with your account and transactions</p>
            </div>
            
            <div class="support-layout">
                <!-- Conversations sidebar -->
                <div class="conversations-sidebar">
                    <div class="conversations-header">
                        <h3>Conversations</h3>
                        <button class="new-chat-btn" id="newChatBtn">
                            <i class="fas fa-plus"></i> New Chat
                        </button>
                    </div>
                    
                    <div class="conversations-list" id="conversationsList">
                        {% for session in sessions %}
                        <div class="conversation-item {% if forloop.first %}active{% endif %}" data-id="{{ session.chat.id }}">
                            <div class="conversation-avatar">
                                <i class="fas fa-user-headset"></i>
                            </div>
                            <div class="conversation-details">
                                <div class="conversation-title">
                                    <span class="agent-name">{{ session.chat.subject|default:"Support Chat" }}</span>
                                    <span class="conversation-time">
                                        {{ session.chat.started_at|timesince }} ago
                                    </span>
                                </div>
                                <p class="conversation-preview">
                                    {% if session.messages.last %}
                                        {{ session.messages.last.content|truncatewords:8 }}
                                    {% else %}
                                        No messages yet
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        {% empty %}
                        <div class="no-conversations">
                            <i class="fas fa-comments" style="font-size: 2rem; color: var(--primary-gold); margin-bottom: 10px;"></i>
                            <p>No conversations yet</p>
                            <p class="text-muted">Start a new chat to get help</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Chat area -->
                <div class="chat-area">
                    <div class="chat-header">
                        <div class="current-chat-info">
                            <div class="chat-agent-avatar">
                                <i class="fas fa-user-headset"></i>
                            </div>
                            <div>
                                <h4 id="chatTitle">Customer Support</h4>
                                <div class="agent-status">
                                    <span class="status-indicator online"></span>
                                    <span>Online</span>
                                </div>
                            </div>
                        </div>
                        <div class="chat-actions">
                            <button class="chat-action-btn" title="Call">
                                <i class="fas fa-phone"></i>
                            </button>
                            <button class="chat-action-btn" title="Video Call">
                                <i class="fas fa-video"></i>
                            </button>
                            <button class="chat-action-btn" title="More options">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="messages-container" id="messagesContainer">
                        {% if sessions %}
                            {% for message in sessions.0.messages %}
                            <div class="message {% if message.sender == request.user %}user-message{% else %}agent-message{% endif %}">
                                {% if message.sender != request.user %}
                                <div class="message-avatar">
                                    <i class="fas fa-user-headset"></i>
                                </div>
                                {% endif %}
                                <div class="message-content">
                                    <div class="message-text">{{ message.content }}</div>
                                    <div class="message-time">{{ message.timestamp|date:"H:i" }}</div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="no-messages">
                                <p>Select a conversation or start a new one</p>
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="message-input-container">
                        <div class="message-input-actions">
                            <button class="input-action-btn">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <button class="input-action-btn">
                                <i class="fas fa-image"></i>
                            </button>
                        </div>
                        <input type="text" placeholder="Type your message..." class="message-input" id="messageInput" />
                        <button class="send-message-btn" id="sendMessageBtn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- New Chat Modal -->
<div id="newChatModal" class="modal" style="display:none">
    <div class="modal-content">
        <span class="close-btn" id="closeModal">&times;</span>
        <h3>Start New Conversation</h3>
        <form id="newChatForm">
            <label for="chatSubject">Subject</label>
            <input type="text" id="chatSubject" name="chatSubject" placeholder="Enter subject..." required />

            <label for="firstMessage">Message</label>
            <textarea id="firstMessage" name="firstMessage" rows="3" placeholder="Type your message..." required></textarea>

            <button type="submit" class="modal-submit-btn">Start Chat</button>
        </form>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const messagesContainer = document.getElementById("messagesContainer");
    const messageInput = document.getElementById("messageInput");
    const sendMessageBtn = document.getElementById("sendMessageBtn");
    const conversationsList = document.getElementById("conversationsList");
    const chatTitle = document.getElementById("chatTitle");

    // Modal elements
    const newChatModal = document.getElementById("newChatModal");
    const closeModal = document.getElementById("closeModal");
    const newChatBtn = document.getElementById("newChatBtn");
    const newChatForm = document.getElementById("newChatForm");

    function scrollToBottom() {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Send message
    function sendMessage() {
        const messageText = messageInput.value.trim();
        if (!messageText) return;

        const messageElement = document.createElement("div");
        messageElement.className = "message user-message";
        messageElement.innerHTML = `
            <div class="message-content">
                <div class="message-text">${messageText}</div>
                <div class="message-time">Just now</div>
            </div>
        `;
        messagesContainer.appendChild(messageElement);
        messageInput.value = "";
        scrollToBottom();
    }

    sendMessageBtn.addEventListener("click", sendMessage);
    messageInput.addEventListener("keypress", e => {
        if (e.key === "Enter") {
            e.preventDefault();
            sendMessage();
        }
    });

    // Switch conversations
    conversationsList.addEventListener("click", function(e) {
        const item = e.target.closest(".conversation-item");
        if (!item) return;

        document.querySelectorAll(".conversation-item").forEach(i => i.classList.remove("active"));
        item.classList.add("active");

        chatTitle.textContent = item.querySelector(".agent-name").textContent;

        // In real app, fetch chat messages via AJAX
        messagesContainer.innerHTML = `
            <div class="chat-date-divider"><span>Today</span></div>
            <div class="message agent-message">
                <div class="message-avatar"><i class="fas fa-user-headset"></i></div>
                <div class="message-content">
                    <div class="message-text">Welcome back to this conversation!</div>
                    <div class="message-time">Just now</div>
                </div>
            </div>
        `;
        scrollToBottom();
    });

    // Modal handling
    newChatBtn.addEventListener("click", () => newChatModal.style.display = "flex");
    closeModal.addEventListener("click", () => newChatModal.style.display = "none");
    window.addEventListener("click", e => { if (e.target === newChatModal) newChatModal.style.display = "none"; });

    newChatForm.addEventListener("submit", function(e) {
        e.preventDefault();
        const subject = document.getElementById("chatSubject").value.trim();
        const firstMessage = document.getElementById("firstMessage").value.trim();
        if (!subject || !firstMessage) return;

        // Create new conversation item
        const newConversation = document.createElement("div");
        newConversation.className = "conversation-item active";
        newConversation.innerHTML = `
            <div class="conversation-avatar"><i class="fas fa-user-headset"></i></div>
            <div class="conversation-details">
                <div class="conversation-title">
                    <span class="agent-name">${subject}</span>
                    <span class="conversation-time">Just now</span>
                </div>
                <p class="conversation-preview">${firstMessage}</p>
            </div>
        `;

        document.querySelectorAll(".conversation-item").forEach(i => i.classList.remove("active"));
        conversationsList.prepend(newConversation);

        // Load chat
        chatTitle.textContent = subject;
        messagesContainer.innerHTML = `
            <div class="chat-date-divider"><span>Today</span></div>
            <div class="message user-message">
                <div class="message-content">
                    <div class="message-text">${firstMessage}</div>
                    <div class="message-time">Just now</div>
                </div>
            </div>
        `;
        scrollToBottom();

        // Reset + close
        newChatForm.reset();
        newChatModal.style.display = "none";
    });
});
</script>

<style>
/* Support container */
.support-container {
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}
.support-header { margin-bottom: 24px; }
.support-header h2 { color: var(--primary-dark); margin-bottom: 8px; }
.support-header p { color: var(--text-muted); }
.support-layout { display: flex; gap: 24px; height: 70vh; }

/* Conversations sidebar */
.conversations-sidebar {
    width: 320px; border-right: 1px solid var(--border-color);
    display: flex; flex-direction: column;
}
.conversations-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border-color);
}
.new-chat-btn {
    background: var(--primary-blue); color: white; border: none;
    border-radius: 6px; padding: 8px 12px; font-size: 0.85rem;
    cursor: pointer; display: flex; align-items: center; gap: 6px;
}
.conversations-list { flex: 1; overflow-y: auto; }
.conversation-item {
    display: flex; align-items: center; padding: 12px;
    border-radius: 8px; cursor: pointer; transition: background 0.2s; position: relative;
}
.conversation-item:hover { background: #f8f9fa; }
.conversation-item.active { background: rgba(25,103,210,0.07); }
.conversation-avatar {
    width: 40px; height: 40px; border-radius: 50%;
    background: var(--primary-gold); color: white;
    display: flex; align-items: center; justify-content: center;
    margin-right: 12px; flex-shrink: 0;
}
.conversation-details { flex: 1; min-width: 0; }
.conversation-title {
    display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;
}
.agent-name { font-weight: 600; color: var(--primary-dark); }
.conversation-time { font-size: 0.75rem; color: var(--text-muted); }
.conversation-preview {
    margin: 0; font-size: 0.85rem; color: var(--text-muted);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.no-conversations { text-align: center; padding: 40px 20px; color: var(--text-muted); }

/* Chat area */
.chat-area { flex: 1; display: flex; flex-direction: column; background: #f8f9fa; border-radius: 8px; overflow: hidden; }
.chat-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 16px 20px; background: white; border-bottom: 1px solid var(--border-color);
}
.current-chat-info { display: flex; align-items: center; gap: 12px; }
.chat-agent-avatar {
    width: 40px; height: 40px; border-radius: 50%; background: var(--primary-blue);
    color: white; display: flex; align-items: center; justify-content: center;
}
.agent-status { display: flex; align-items: center; gap: 6px; font-size: 0.85rem; color: var(--text-muted); }
.status-indicator { width: 8px; height: 8px; border-radius: 50%; background: var(--success); }
.chat-actions { display: flex; gap: 8px; }
.chat-action-btn {
    width: 36px; height: 36px; border-radius: 50%; border: none;
    background: transparent; color: var(--text-muted);
    cursor: pointer; display: flex; align-items: center; justify-content: center;
}
.chat-action-btn:hover { background: #f1f3f5; color: var(--primary-dark); }

/* Messages */
.messages-container { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 16px; }
.chat-date-divider { text-align: center; margin: 10px 0; position: relative; }
.chat-date-divider span {
    background: #f8f9fa; padding: 0 12px; color: var(--text-muted);
    font-size: 0.85rem; position: relative; z-index: 1;
}
.chat-date-divider:before {
    content: ''; position: absolute; top: 50%; left: 0; right: 0;
    height: 1px; background: var(--border-color); z-index: 0;
}
.message { display: flex; gap: 10px; max-width: 80%; }
.agent-message { align-self: flex-start; }
.user-message { align-self: flex-end; flex-direction: row-reverse; }
.message-avatar {
    width: 32px; height: 32px; border-radius: 50%; background: var(--primary-gold);
    color: white; display: flex; align-items: center; justify-content: center; flex-shrink: 0;
}
.message-content {
    background: white; padding: 12px 16px; border-radius: 18px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1); position: relative;
}
.user-message .message-content { background: var(--primary-blue); color: white; }
.message-text { margin-bottom: 4px; }
.message-time { font-size: 0.75rem; color: var(--text-muted); text-align: right; }
.user-message .message-time { color: rgba(255,255,255,0.7); }

/* Input */
.message-input-container {
    display: flex; align-items: center; padding: 16px;
    background: white; border-top: 1px solid var(--border-color); gap: 10px;
}
.message-input-actions { display: flex; gap: 8px; }
.input-action-btn {
    width: 36px; height: 36px; border-radius: 50%; border: none;
    background: transparent; color: var(--text-muted);
    cursor: pointer; display: flex; align-items: center; justify-content: center;
}
.input-action-btn:hover { background: #f1f3f5; color: var(--primary-dark); }
.message-input {
    flex: 1; border: 1px solid var(--border-color); border-radius: 24px;
    padding: 10px 16px; outline: none;
}
.message-input:focus { border-color: var(--primary-blue); }
.send-message-btn {
    width: 40px; height: 40px; border-radius: 50%;
    border: none; background: var(--primary-blue); color: white;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
}
.send-message-btn:hover { background: var(--primary-dark); }

/* Modal */
.modal {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.4);
    display: flex; align-items: center; justify-content: center;
    z-index: 1000;
}
.modal-content {
    background: white; padding: 24px; border-radius: 12px;
    width: 400px; max-width: 90%; position: relative;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}
.close-btn {
    position: absolute; top: 12px; right: 12px;
    font-size: 1.5rem; cursor: pointer; color: var(--text-muted);
}
.modal-content h3 { margin-bottom: 16px; color: var(--primary-dark); }
.modal-content label { display: block; font-weight: 600; margin-bottom: 6px; }
.modal-content input, .modal-content textarea {
    width: 100%; padding: 10px; border: 1px solid var(--border-color);
    border-radius: 6px; margin-bottom: 12px; outline: none;
}
.modal-content input:focus, .modal-content textarea:focus { border-color: var(--primary-blue); }
.modal-submit-btn {
    background: var(--primary-blue); color: white; border: none;
    padding: 10px 16px; border-radius: 6px; cursor: pointer;
}
.modal-submit-btn:hover { background: var(--primary-dark); }

/* Responsive */
@media (max-width: 768px) {
    .support-layout { flex-direction: column; height: auto; }
    .conversations-sidebar { width: 100%; border-right: none; border-bottom: 1px solid var(--border-color); max-height: 200px; }
}
</style>
{% endblock content %}
